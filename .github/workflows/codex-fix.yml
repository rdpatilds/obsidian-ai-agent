name: Codex Fix (Write Access)

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  codex-fix:
    if: |
      (
        github.event_name == 'issue_comment' ||
        github.event_name == 'pull_request_review_comment'
      ) &&
      (contains(github.event.comment.body, '@codex-fix') || contains(github.event.comment.body, '@codex-create')) &&
      contains(fromJSON('["coleam00"]'), github.event.comment.user.login)

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "codex-bot"
          git config user.email "codex-bot@users.noreply.github.com"

      - name: Create branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            NUM="${{ github.event.issue.number }}"
          else
            NUM="${{ github.event.pull_request.number }}"
          fi

          BRANCH_NAME="fix/issue-$NUM-codex"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "ISSUE_NUM=$NUM" >> $GITHUB_ENV

      - name: Load instructions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_JSON=$(gh issue view $ISSUE_NUM --json labels,title,body)
          LABELS=$(echo "$ISSUE_JSON" | jq -r '.labels[].name' | tr '\n' ' ')
          TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          BODY=$(echo "$ISSUE_JSON" | jq -r '.body')

          if echo "$LABELS" | grep -qiE "enhancement|feature|new feature"; then
            TEMPLATE_FILE=".github/workflows/prompts/end-to-end-feature-github.md"
          elif echo "$LABELS" | grep -qi "bug"; then
            TEMPLATE_FILE=".github/workflows/prompts/bug-fix-github.md"
          else
            TEMPLATE_FILE=".github/workflows/prompts/bug-fix-github.md"
          fi

          TEMPLATE=$(cat $TEMPLATE_FILE)
          TEMPLATE="${TEMPLATE//\$REPOSITORY/${{ github.repository }}}"
          TEMPLATE="${TEMPLATE//\$ISSUE_NUMBER/$ISSUE_NUM}"
          TEMPLATE="${TEMPLATE//\$ISSUE_TITLE/$TITLE}"
          TEMPLATE="${TEMPLATE//\$ISSUE_BODY/$BODY}"
          TEMPLATE="${TEMPLATE//\$TRIGGERED_BY/${{ github.event.comment.user.login }}}"
          TEMPLATE="${TEMPLATE//\$BRANCH_NAME/$BRANCH_NAME}"
          TEMPLATE="${TEMPLATE//\$CREATE_BRANCH/false}"
          TEMPLATE="${TEMPLATE//\$CREATE_PR/false}"
          TEMPLATE="${TEMPLATE//\$COMMENT_ON_ISSUE/false}"
          TEMPLATE="${TEMPLATE//\$PLAN_PATH/}"

          echo "$TEMPLATE" > /tmp/codex_prompt.txt

      - name: Run Codex
        id: codex
        uses: openai/codex-action@v1
        timeout-minutes: 30
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: /tmp/codex_prompt.txt
          output-file: codex-output.md
          sandbox: workspace-write

      - name: Commit changes
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            ISSUE_JSON=$(gh issue view $ISSUE_NUM --json title --jq '.title')
            git commit -m "feat: $ISSUE_JSON

Automated fix by Codex for issue #$ISSUE_NUM"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push branch
        run: git push origin $BRANCH_NAME

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_JSON=$(gh issue view $ISSUE_NUM --json title,body)
          TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          BODY=$(echo "$ISSUE_JSON" | jq -r '.body')

          echo "Fixes #$ISSUE_NUM" > /tmp/pr-body.md
          echo "" >> /tmp/pr-body.md
          echo "$BODY" >> /tmp/pr-body.md
          echo "" >> /tmp/pr-body.md
          echo "---" >> /tmp/pr-body.md
          echo "*Automated fix by Codex*" >> /tmp/pr-body.md

          PR_URL=$(gh pr create \
            --title "Fix: $TITLE" \
            --body-file /tmp/pr-body.md \
            --base main \
            --head $BRANCH_NAME)

          echo "PR_URL=$PR_URL" >> $GITHUB_ENV

      - name: Comment on issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment $ISSUE_NUM --body "✅ Fix implemented. PR: $PR_URL"

  unauthorized:
    if: |
      (
        github.event_name == 'issue_comment' ||
        github.event_name == 'pull_request_review_comment'
      ) &&
      (contains(github.event.comment.body, '@codex-fix') || contains(github.event.comment.body, '@codex-create')) &&
      !contains(fromJSON('["coleam00"]'), github.event.comment.user.login)

    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'issue_comment') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `❌ @${context.actor} - Not authorized`
              });
            }
