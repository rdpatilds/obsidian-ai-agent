name: Codex Fix (Write Access)

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  codex-fix:
    # Only trigger on @codex-fix or @codex-create command from authorized users
    if: |
      (
        github.event_name == 'issue_comment' ||
        github.event_name == 'pull_request_review_comment'
      ) &&
      (contains(github.event.comment.body, '@codex-fix') || contains(github.event.comment.body, '@codex-create')) &&
      contains(fromJSON('["coleam00"]'), github.event.comment.user.login)

    runs-on: ubuntu-latest

    permissions:
      contents: write # Allow creating branches and editing files
      pull-requests: write # Allow creating and updating pull requests
      issues: write # Allow commenting on and updating issues
      id-token: write # Required for OIDC authentication
      actions: read # Read CI results

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better context

      - name: Configure Git
        run: |
          git config user.name "codex-bot"
          git config user.email "codex-bot@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get Issue/PR Number
        id: get-number
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_ENV
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          fi

      - name: Create branch for implementation
        run: |
          # Create and checkout new branch
          BRANCH_NAME="fix/issue-${{ env.number }}-codex"
          git checkout -b ${BRANCH_NAME}
          echo "Created and checked out branch: ${BRANCH_NAME}"

      - name: Fetch issue/PR details
        id: fetch-details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch the issue or PR details using GitHub CLI
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            gh issue view ${{ env.number }} --json title,body,comments --jq '{title,body,comments: [.comments[] | {author: .author.login, body: .body}]}' > /tmp/issue-details.json
          else
            gh pr view ${{ env.number }} --json title,body,comments --jq '{title,body,comments: [.comments[] | {author: .author.login, body: .body}]}' > /tmp/issue-details.json
          fi

      - name: Prepare fix instructions
        run: |
          # Read issue/PR details
          ISSUE_DETAILS=$(cat /tmp/issue-details.json)
          ISSUE_TITLE=$(echo "$ISSUE_DETAILS" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_DETAILS" | jq -r '.body')

          # Get labels from issue
          LABELS=$(gh issue view ${{ env.number }} --json labels --jq '.labels[].name' | tr '\n' ' ')

          echo "Issue #${{ env.number }}: $ISSUE_TITLE"
          echo "Labels: $LABELS"

          # Determine workflow based on labels
          if echo "$LABELS" | grep -qiE "enhancement|feature|new feature"; then
            echo "Detected FEATURE REQUEST workflow"

            # Load and process end-to-end feature workflow
            INSTRUCTIONS=$(cat .claude/commands/end-to-end-feature.md | sed "s/\$ARGUMENTS/${ISSUE_BODY}/g")

            # Write instructions to file
            printf '%s\n' \
              "# GitHub Context" \
              "- Repository: ${{ github.repository }}" \
              "- Issue Number: ${{ env.number }}" \
              "- Issue Title: $ISSUE_TITLE" \
              "- Triggered by: ${{ github.event.comment.user.login }}" \
              "" \
              "# Feature Request from Issue #${{ env.number }}" \
              "" \
              "## Feature Description" \
              "${ISSUE_BODY}" \
              "" \
              "## Additional Instructions" \
              "You are already on branch: fix/issue-${{ env.number }}-codex" \
              "" \
              "After completing the implementation:" \
              "1. Commit all changes to the current branch with a descriptive commit message" \
              "2. Push the branch to origin" \
              "" \
              "Note: The GitHub Actions workflow will automatically create a pull request and comment on the issue." \
              "" \
              "---" \
              "" \
              "${INSTRUCTIONS}" \
              > /tmp/codex-fix-prompt.md

          elif echo "$LABELS" | grep -qi "bug"; then
            echo "Detected BUG workflow"

            # Load and process RCA and implement-fix workflows
            RCA_INSTRUCTIONS=$(cat .claude/commands/github_bug_fix/rca.md | sed "s/\$ARGUMENTS/${{ env.number }}/g")
            FIX_INSTRUCTIONS=$(cat .claude/commands/github_bug_fix/implement-fix.md | sed "s/\$ARGUMENTS/${{ env.number }}/g")

            # Write instructions to file
            printf '%s\n' \
              "# GitHub Context" \
              "- Repository: ${{ github.repository }}" \
              "- Issue Number: ${{ env.number }}" \
              "- Issue Title: $ISSUE_TITLE" \
              "- Triggered by: ${{ github.event.comment.user.login }}" \
              "" \
              "# Bug Fix Workflow for Issue #${{ env.number }}" \
              "" \
              "This is a TWO-PHASE workflow:" \
              "" \
              "## Phase 1: Root Cause Analysis" \
              "" \
              "${RCA_INSTRUCTIONS}" \
              "" \
              "---" \
              "" \
              "## Phase 2: Implement Fix" \
              "" \
              "${FIX_INSTRUCTIONS}" \
              "" \
              "## Additional Instructions" \
              "You are already on branch: fix/issue-${{ env.number }}-codex" \
              "" \
              "After implementing the fix:" \
              "1. Commit all changes (including the RCA document) to the current branch with a descriptive commit message" \
              "2. Push the branch to origin" \
              "" \
              "Note: The GitHub Actions workflow will automatically create a pull request and comment on the issue." \
              > /tmp/codex-fix-prompt.md

          else
            echo "No specific workflow detected"

            # Write instructions to file
            printf '%s\n' \
              "# GitHub Context" \
              "- Repository: ${{ github.repository }}" \
              "- Issue Number: ${{ env.number }}" \
              "- Triggered by: ${{ github.event.comment.user.login }}" \
              "" \
              "## Issue Details" \
              "\`\`\`json" \
              "${ISSUE_DETAILS}" \
              "\`\`\`" \
              "" \
              "You are already on branch: fix/issue-${{ env.number }}-codex" \
              "" \
              "Analyze and fix this issue." \
              "After implementing:" \
              "1. Commit changes to the current branch with a descriptive commit message" \
              "2. Push to origin" \
              "" \
              "Note: The GitHub Actions workflow will automatically create a pull request and comment on the issue." \
              > /tmp/codex-fix-prompt.md
          fi

      - name: Run Codex Fix
        id: codex
        uses: openai/codex-action@v1
        timeout-minutes: 30
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}

          # Fix-specific instructions loaded from template
          prompt-file: /tmp/codex-fix-prompt.md

          # Output file for Codex results
          output-file: codex-output.md

          # Configure Codex for workspace write access
          sandbox: workspace-write

      - name: Prepare PR body
        if: success()
        run: |
          # Create PR body with Codex output
          echo "## Automated Fix by Codex" > /tmp/pr-body.md
          echo "" >> /tmp/pr-body.md
          echo "This PR was automatically generated by Codex in response to issue #${{ env.number }}." >> /tmp/pr-body.md
          echo "" >> /tmp/pr-body.md

          # Include Codex output if it exists
          if [ -f codex-output.md ]; then
            echo "## Codex Analysis" >> /tmp/pr-body.md
            echo "" >> /tmp/pr-body.md
            cat codex-output.md >> /tmp/pr-body.md
            echo "" >> /tmp/pr-body.md
          fi

          echo "---" >> /tmp/pr-body.md
          echo "*Fixed by Codex*" >> /tmp/pr-body.md

      - name: Create pull request with fixes
        if: success()
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "fix: resolve issue via Codex"
          branch: fix/issue-${{ env.number }}-codex
          title: "Fix: Automated fix via Codex"
          body-path: /tmp/pr-body.md

      - name: Comment on issue
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ env.number }};
            const prNumber = ${{ steps.create-pr.outputs.pull-request-number }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `✅ Codex created PR #${prNumber} to fix this issue`
            });

  unauthorized-message:
    # Post message for unauthorized users
    if: |
      (
        github.event_name == 'issue_comment' ||
        github.event_name == 'pull_request_review_comment'
      ) &&
      (contains(github.event.comment.body, '@codex-fix') || contains(github.event.comment.body, '@codex-create')) &&
      !contains(fromJSON('["coleam00"]'), github.event.comment.user.login)

    runs-on: ubuntu-latest

    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Post unauthorized message
        uses: actions/github-script@v7
        with:
          script: |
            const comment = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ @${context.actor} - You are not authorized to trigger Codex fixes.\n\nOnly maintainers can trigger Codex: Please ask a maintainer to run the fix command.`
            };

            if (context.eventName === 'issue_comment') {
              await github.rest.issues.createComment({
                ...comment,
                issue_number: context.issue.number
              });
            } else if (context.eventName === 'pull_request_review_comment') {
              await github.rest.pulls.createReplyForReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                comment_id: context.payload.comment.id,
                body: comment.body
              });
            }
